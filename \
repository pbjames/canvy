from typing import ClassVar, override

from canvy.tui.const import CanvyMode
from canvy.types import CanvyConfig, ModelProvider
from canvy.utils import get_config
from textual import on
from textual.app import ComposeResult
from textual.containers import HorizontalGroup
from textual.screen import Screen
from textual.widgets import Button, Input, Static


class Provider(Static):
    config: CanvyConfig
    provider_type: ModelProvider

    DEFAULT_CSS: ClassVar[str] = """
    ProviderWidget {
        layout: vertical;
        width: 100%;
        height: auto;
        border: hkey $primary;
        margin: 1;
    }

    ProviderWidget.valid {
        background: rgba(0, 255, 0, 0.16);
        border: hkey green;
    }

    ProviderWidget.invalid {
        background: rgba(128, 128, 128, 0.08);
        border: hkey gray;
    }

    ProviderWidget > Static {
        width: 100%;
        content-align: center middle;
        text-style: bold;
        margin-bottom: 1;
    }

    ProviderWidget Input {
        margin: 0 1;
    }
    """

    @override
    def compose(self) -> ComposeResult:
        yield Static(f"{self.provider_type.value}")
        if self.provider_type is ModelProvider.OPENAI:
            yield Input(
                value=self.config.openai_key,
                placeholder="Enter OpenAI API key",
                id="openai_key",
                password=True,
            )
        elif self.provider_type is ModelProvider.ANTHRO:
            yield Input(
                value=self.config.anthropic_key,
                placeholder="Enter Anthropic API key",
                id="anthropic_key", 
                password=True,
            )
        elif self.provider_type is ModelProvider.OLLAMA:
            yield Input(
                value=self.config.ollama_model,
                placeholder="Enter Ollama model name",
                id="ollama_model",
            )

    def __init__(self, config: CanvyConfig, provider: ModelProvider) -> None:
        super().__init__()
        self.config = config
        self.provider_type = provider
        self.refresh_validation_state()

    def config_mutator(self, config: CanvyConfig):
        if self.provider_type is ModelProvider.OPENAI:
            config.openai_key = self.config.openai_key
        elif self.provider_type is ModelProvider.ANTHRO:
            config.anthropic_key = self.config.anthropic_key
        elif self.provider_type is ModelProvider.OLLAMA:
            config.ollama_model = self.config.ollama_model
        return config

    @property
    def valid(self) -> bool:
        # TODO: Update this
        input_widget = self.query_exactly_one(Input)
        return bool(input_widget.value)

    def refresh_validation_state(self) -> None:
        self.remove_class("valid")
        self.remove_class("invalid")
        self.add_class("valid" if self.valid else "invalid")

    @on(Input.Changed)
    def on_input_changed(self) -> None:
        self.refresh_validation_state()


class SettingsPage(Screen[None]):
    config: CanvyConfig

    DEFAULT_CSS: ClassVar[str] = """
    SettingsPage {
        layout: vertical;
        align: center middle;
    }
    
    #settings_container {
        layout: vertical;
        border-title-align: center;
        max-width: 50%;
        min-width: 60;
        border: heavy $primary;
        padding: 2;
        background: $surface;
    }

    Input {
        margin: 1 0;
    }

    Button {
        margin: 1;
    }

    #button_group {
        margin-top: 2;
    }
    """

    def __init__(self, name: str | None = None, id: str | None = None, classes: str | None = None) -> None:
        super().__init__(name, id, classes)
        self.config = get_config()

    @override
    def compose(self) -> ComposeResult:
        with Static(id="settings_container") as container:
            container.border_title = "Settings"
            for provider in ModelProvider:
                if provider != ModelProvider.NONE:
                    yield Provider(self.config, provider)
            with HorizontalGroup(id="button_group"):
                yield Button("Save", id="save_button", variant="primary")
                yield Button("Back", id="quit_button", variant="error")

    @on(Button.Pressed, "#save_button")
    def save_settings(self) -> None:
        providers = self.query(Provider)
        self.notify("Settings saved successfully!", severity="information")

    @on(Button.Pressed, "#quit_button")
    def quit(self):
        self.app.switch_mode(CanvyMode.MAIN)
